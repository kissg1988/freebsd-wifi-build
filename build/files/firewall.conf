# The default ruleset allows all connections from LAN and adds a few basic protections.
# NAT settings are in /etc/cfg/rc.conf
# Custom rules can be added to /etc/cfg/firewall.custom.conf

# IDs 200 & 201 are reserved for NAT
ruleid=202
ipfw add ${ruleid} check-state; ruleid=$((ruleid + 1))
ipfw add ${ruleid} allow udp from any to any 67 out via ${firewall_nat_public_interface} keep-state; ruleid=$((ruleid + 1))
for ipsubnet in 192.168.0.0/16 172.16.0.0/12 10.0.0.0/8 127.0.0.0/8 0.0.0.0/8 \
	169.254.0.0/16 192.0.2.0/24 198.51.100.0/24 203.0.113.0/24 204.152.64.0/23 \
	224.0.0.0/4 240.0.0.0/4
do
    ipfw add ${ruleid} deny all from ${ipsubnet} to any in via ${firewall_nat_public_interface};  ruleid=$((ruleid + 1))
    ipfw add ${ruleid} deny all from any to ${ipsubnet} out via ${firewall_nat_public_interface}; ruleid=$((ruleid + 1))
done
ipfw add ${ruleid} deny ip from any to any frag in via ${firewall_nat_public_interface}; ruleid=$((ruleid + 1))
ipfw add ${ruleid} deny tcp from any to any established in via ${firewall_nat_public_interface}; ruleid=$((ruleid + 1))
ipfw add ${ruleid} allow ip from any to any via lo0 keep-state; ruleid=$((ruleid + 1))
ipfw add ${ruleid} allow ip from any to any in via bridge0 keep-state; ruleid=$((ruleid + 1))
ipfw add ${ruleid} allow ip from any to any out via bridge0 keep-state; ruleid=$((ruleid + 1))

[ -f /etc/cfg/firewall.custom.conf ] &&
	. /etc/cfg/firewall.custom.conf

# Some kernel configurations have an "allow all by default" policy hence the explicit deny rule
ipfw add 65534 deny ip from any to any
